<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå± AgroStable</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%);
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      line-height: 1.6;
    }
    /* HERO SECTION */
    .hero {
      background: linear-gradient(135deg, rgba(46,125,50,0.92) 0%, rgba(25,118,210,0.88) 100%), url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat;
      color: #fff;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 24px;
      position: relative;
      border-radius: 0 0 40px 40px;
      margin-bottom: 0;
      box-shadow: 0 8px 32px rgba(67,233,123,0.08);
      overflow: hidden;
    }
    .hero-title {
      font-size: 3.2rem;
      font-weight: 800;
      margin-bottom: 18px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      color: #fff;
      text-shadow: 0 2px 16px rgba(46,125,50,0.18);
    }
    .hero-subtitle {
      font-size: 1.7rem;
      font-weight: 500;
      margin-bottom: 18px;
      color: #e0f2f1;
      text-shadow: 0 1px 8px rgba(25,118,210,0.13);
    }
    .hero-desc {
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 32px;
      color: #e3fcec;
      text-shadow: 0 1px 8px rgba(25,118,210,0.10);
    }
    .hero-cta {
      background: linear-gradient(135deg, #4CAF50 0%, #1976D2 100%);
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 20px 60px;
      font-size: 1.35rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(33,150,243,0.10);
      transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }
    .hero-cta:hover {
      background: linear-gradient(135deg, #388e3c 0%, #1976d2 100%);
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 8px 32px rgba(33,150,243,0.18);
    }
    /* Estad√≠sticas HERO */
    .hero-stats {
      display: flex;
      gap: 40px;
      justify-content: center;
      margin-top: 48px;
      flex-wrap: wrap;
      animation: fadeInUp 1.2s cubic-bezier(.23,1.01,.32,1) both;
    }
    .hero-stat {
      background: rgba(255,255,255,0.13);
      border-radius: 16px;
      padding: 22px 36px;
      color: #fff;
      font-size: 1.18rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(33,150,243,0.10);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 180px;
      margin-bottom: 8px;
      backdrop-filter: blur(2px);
    }
    .hero-stat-icon {
      font-size: 2.2rem;
      margin-right: 8px;
    }
    /* SEPARACI√ìN ENTRE SECCIONES */
    .section {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 0 auto;
      padding: 80px 24px 80px 24px;
      box-sizing: border-box;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.06);
      margin-bottom: 80px;
      background: #fff;
    }
    .section.bg-alt {
      background: #f7fafc;
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    }
    /* QU√â ANALIZAMOS */
    .analizamos-cards {
      display: flex;
      gap: 32px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .analizamos-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 18px rgba(76,175,80,0.07);
      padding: 44px 32px 44px 32px;
      flex: 1 1 260px;
      min-width: 260px;
      max-width: 370px;
      text-align: center;
      margin-bottom: 16px;
      transition: box-shadow 0.2s, transform 0.2s;
      border: 2px solid #e0f2f1;
      animation: fadeInUp 1.1s cubic-bezier(.23,1.01,.32,1) both;
      min-height: 370px;
    }
    .analizamos-card:hover {
      box-shadow: 0 8px 32px rgba(33,150,243,0.13);
      transform: translateY(-4px) scale(1.03);
      border-color: #b2dfdb;
    }
    .analizamos-icon {
      font-size: 3.5rem;
      margin-bottom: 18px;
      display: block;
    }
    .analizamos-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #2E7D32;
      letter-spacing: 0.2px;
    }
    .analizamos-desc {
      font-size: 1.08rem;
      color: #222;
      margin-bottom: 8px;
      line-height: 1.6;
      text-align: left;
    }
    /* SECCI√ìN TECNOLOG√çA (GRID) */
    .funciona-steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 32px;
      margin-top: 32px;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 1024px) {
      .funciona-steps { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .funciona-steps { grid-template-columns: 1fr; }
    }
    .funciona-step {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 16px rgba(25,118,210,0.10);
      padding: 30px 18px 30px 18px;
      min-width: 200px;
      max-width: 320px;
      text-align: center;
      margin-bottom: 12px;
      border: 2px solid #e3f2fd;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
      animation: fadeInUp 1.1s cubic-bezier(.23,1.01,.32,1) both;
    }
    .funciona-step:hover {
      box-shadow: 0 8px 32px rgba(76,175,80,0.13);
      transform: translateY(-4px) scale(1.03);
      border-color: #b3e5fc;
    }
    .funciona-step-num {
      font-size: 2.7rem;
      font-weight: 800;
      color: #1976D2;
      margin-bottom: 18px;
      display: block;
    }
    .funciona-step-icon {
      font-size: 3.5rem;
      margin-bottom: 10px;
      display: block;
    }
    .funciona-step-desc {
      font-size: 1.18rem;
      color: #333;
      font-weight: 500;
    }
    /* Estad√≠sticas tecnolog√≠a */
    .funciona-datos {
      margin-top: 36px;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: center;
      animation: fadeInUp 1.2s cubic-bezier(.23,1.01,.32,1) both;
    }
    .funciona-dato {
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 1.18rem;
      font-weight: 600;
      margin-bottom: 8px;
      min-width: 180px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(33,150,243,0.06);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .funciona-dato-icon {
      font-size: 2rem;
      margin-right: 8px;
    }
    /* Cultivos soportados */
    .cultivos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 18px;
      margin-top: 32px;
      margin-bottom: 0;
    }
    .cultivo-item {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(76,175,80,0.07);
      padding: 16px 0;
      text-align: center;
      font-size: 1.08rem;
      font-weight: 600;
      color: #388e3c;
      border: 2px solid #e0f2f1;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
    }
    .cultivo-item:hover {
      box-shadow: 0 8px 32px rgba(33,150,243,0.13);
      transform: translateY(-2px) scale(1.04);
      border-color: #b2dfdb;
    }
    /* Formulario y resultados */
    .main-container {
      max-width: 900px;
      width: 100%;
      background: #fff;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      border-radius: 20px;
      padding: 60px 40px 60px 40px;
      margin: 0 auto 48px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .form-section-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2E7D32;
      margin-bottom: 32px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 20px;
      width: 100%;
    }
    input, select {
      width: 100%;
      padding: 16px 20px;
      border-radius: 12px;
      border: 2px solid #E8F5E8;
      font-size: 16px;
      display: block;
    }
    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 20px;
      margin-top: 8px;
      justify-content: center;
    }
    button[type="submit"] {
      background: linear-gradient(135deg, #4CAF50 0%, #1976D2 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 20px 60px;
      font-size: 20px;
      font-weight: 700;
      width: 100%;
      margin-top: 24px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s, background 0.2s;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.08);
      letter-spacing: 0.5px;
    }
    button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      background: linear-gradient(135deg, #388e3c 0%, #1976d2 100%);
    }
    button#clear-btn {
      background: #F44336;
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 20px 60px;
      font-size: 20px;
      font-weight: 700;
      width: 100%;
      margin-top: 24px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.08);
      letter-spacing: 0.5px;
    }
    button#clear-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.18);
    }
    /* Animaciones */
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    /* Responsive */
    @media (max-width: 1200px) {
      .section, .main-container { max-width: 98vw; }
      .funciona-steps { max-width: 98vw; }
    }
    @media (max-width: 1024px) {
      .section, .main-container { padding: 24px 8px; }
      .hero { padding: 64px 8px 48px 8px; }
      .funciona-steps { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .analizamos-cards, .funciona-datos { flex-direction: column; gap: 18px; }
      .section, .main-container { padding: 16px 2vw; }
      .hero { padding: 40px 2vw 32px 2vw; }
      .form-section-title { font-size: 1.3rem; }
      .funciona-steps { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .funciona-steps { grid-template-columns: 1fr; }
    }
    @media (max-width: 480px) {
      .section, .main-container { padding: 8px 0; }
      .hero-title { font-size: 1.3rem; }
      .hero-subtitle { font-size: 1.1rem; }
      .hero-desc { font-size: 0.98rem; }
      .form-section-title { font-size: 1.1rem; }
    }
    /* Navegaci√≥n suave */
    html {
      scroll-behavior: smooth;
    }
    .language-selector {
        position: fixed;
        top: 10px;
        right: 20px;
        z-index: 9999;
        background: white;
        padding: 5px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .language-selector select {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .language-selector select:hover {
        border-color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="language-selector">
    <select id="languageSelect" onchange="changeLanguage()">
        <option value="es">üá™üá∏ Espa√±ol</option>
        <option value="en">üá∫üá∏ English</option>
        <option value="pt">üáµüáπ Portugu√™s</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="it">üáÆ Italiano</option>
    </select>
  </div>
  <!-- HERO SECTION -->
  <section class="hero" id="hero">
    <div class="hero-title" data-translate="heroTitle"><span class="icon">üå±</span>AgroStable - An√°lisis Satelital Agr√≠cola Inteligente</div>
    <div class="hero-subtitle" data-translate="heroSubtitle">Previene p√©rdidas en tu cultivo con datos satelitales en tiempo real</div>
    <div class="hero-desc" data-translate="heroDescription">Analiza la salud de tu plantaci√≥n, condiciones clim√°ticas y estabilidad del suelo usando tecnolog√≠a espacial de √∫ltima generaci√≥n</div>
    <button class="hero-cta" data-translate="heroButton" onclick="document.getElementById('form-section').scrollIntoView({behavior:'smooth'})">Analizar mi finca gratis</button>
    <div class="hero-stats">
      <div class="hero-stat"><span class="hero-stat-icon">üì°</span>15+ cultivos analizados</div>
      <div class="hero-stat"><span class="hero-stat-icon">üõ∞Ô∏è</span>10m resoluci√≥n espacial</div>
      <div class="hero-stat"><span class="hero-stat-icon">‚è±Ô∏è</span>30 segundos an√°lisis</div>
      <div class="hero-stat"><span class="hero-stat-icon">üìä</span><5% margen error</div>
    </div>
  </section>

  <!-- QU√â ANALIZAMOS -->
  <section class="section" id="analizamos">
    <h2 style="text-align:center; color:#2E7D32; font-size:2rem; font-weight:700; margin-bottom:18px;" data-translate="whatAnalyze">¬øQu√© analizamos en tu finca?</h2>
    <div class="analizamos-cards">
      <div class="analizamos-card">
        <span class="analizamos-icon">üå±</span>
        <div class="analizamos-title" data-translate="ndviTitle">NDVI - Salud de Plantas</div>
        <div class="analizamos-desc" data-translate="ndviDesc">Usando im√°genes multiespectrales de Sentinel-2, medimos la reflectancia infrarroja de tus cultivos. Valores altos indican vegetaci√≥n densa y saludable, mientras valores bajos revelan estr√©s h√≠drico, deficiencias nutricionales, plagas o enfermedades. Nuestro algoritmo compara tu NDVI con rangos √≥ptimos espec√≠ficos para cada cultivo.</div>
      </div>
      <div class="analizamos-card">
        <span class="analizamos-icon">üå§Ô∏è</span>
        <div class="analizamos-title" data-translate="climateTitle">Condiciones Clim√°ticas</div>
        <div class="analizamos-desc" data-translate="climateDesc">Datos meteorol√≥gicos actualizados cada hora desde estaciones globales: temperatura ambiente, humedad relativa, velocidad del viento y condiciones atmosf√©ricas. Evaluamos si tu microclima actual favorece el crecimiento de tu cultivo espec√≠fico seg√∫n par√°metros agron√≥micos establecidos.</div>
      </div>
      <div class="analizamos-card">
        <span class="analizamos-icon">üèîÔ∏è</span>
        <div class="analizamos-title" data-translate="soilTitle">Estabilidad del Suelo</div>
        <div class="analizamos-desc" data-translate="soilDesc">Tecnolog√≠a radar de apertura sint√©tica (SAR) de Sentinel-1 detecta movimientos milim√©tricos del terreno. Medimos subsidencia, expansi√≥n del suelo y microdeformaciones que pueden afectar sistemas de riego, estructuras agr√≠colas y desarrollo radicular de tus plantas.</div>
      </div>
    </div>
  </section>

  <!-- C√ìMO FUNCIONA -->
  <section class="section bg-alt" id="funciona">
    <h2 style="text-align:center; color:#1976d2; font-size:2rem; font-weight:700; margin-bottom:18px;" data-translate="howWorks">Tecnolog√≠a satelital al servicio de tu finca</h2>
    <div class="funciona-steps">
      <div class="funciona-step">
        <span class="funciona-step-icon">üìç</span>
        <span class="funciona-step-num">1</span>
        <div class="funciona-step-desc" data-translate="step1">Ingresa las coordenadas de tu finca</div>
      </div>
      <div class="funciona-step">
        <span class="funciona-step-icon">üõ∞Ô∏è</span>
        <span class="funciona-step-num">2</span>
        <div class="funciona-step-desc" data-translate="step2">Nuestros algoritmos consultan sat√©lites Sentinel en tiempo real</div>
      </div>
      <div class="funciona-step">
        <span class="funciona-step-icon">üì°</span>
        <span class="funciona-step-num">3</span>
        <div class="funciona-step-desc" data-translate="step3">Recibes an√°lisis detallado con recomendaciones espec√≠ficas</div>
      </div>
      <div class="funciona-step">
        <span class="funciona-step-icon">üìä</span>
        <span class="funciona-step-num">4</span>
        <div class="funciona-step-desc" data-translate="step4">Visualiza la ubicaci√≥n analizada en mapa interactivo</div>
      </div>
    </div>
    <div class="funciona-datos">
      <div class="funciona-dato"><span class="funciona-dato-icon">üì°</span><span data-translate="coverage">Cobertura: Mundial</span></div>
      <div class="funciona-dato"><span class="funciona-dato-icon">üõ∞Ô∏è</span><span data-translate="resolution">Resoluci√≥n: hasta 10 metros</span></div>
      <div class="funciona-dato"><span class="funciona-dato-icon">üå±</span><span data-translate="crops">15 cultivos soportados</span></div>
      <div class="funciona-dato"><span class="funciona-dato-icon">‚è±Ô∏è</span><span data-translate="speed">An√°lisis en menos de 30 segundos</span></div>
    </div>
  </section>

  <!-- CULTIVOS SOPORTADOS -->
  <section class="section" id="cultivos">
    <h2 style="text-align:center; color:#2E7D32; font-size:2rem; font-weight:700; margin-bottom:18px;" data-translate="cropsTitle">Cultivos analizados</h2>
    <div class="cultivos-grid">
      <div class="cultivo-item">Caf√©</div>
      <div class="cultivo-item">Tomate</div>
      <div class="cultivo-item">Ma√≠z</div>
      <div class="cultivo-item">Arroz</div>
      <div class="cultivo-item">Papa</div>
      <div class="cultivo-item">Frijol</div>
      <div class="cultivo-item">Cebolla</div>
      <div class="cultivo-item">Lechuga</div>
      <div class="cultivo-item">Pl√°tano</div>
      <div class="cultivo-item">Ca√±a de az√∫car</div>
      <div class="cultivo-item">Cacao</div>
      <div class="cultivo-item">Yuca</div>
      <div class="cultivo-item">Flores</div>
      <div class="cultivo-item">Trigo</div>
      <div class="cultivo-item">Aguacate</div>
    </div>
  </section>

  <!-- FORMULARIO Y RESULTADOS -->
  <section class="section bg-alt" id="form-section" style="padding-left:0; padding-right:0; margin:60px auto 80px auto;">
    <div class="form-section-title">Analiza tu finca ahora</div>
    <div class="main-container" style="box-shadow: 0 8px 32px rgba(94, 53, 177, 0.15); border: 1px solid rgba(94, 53, 177, 0.1); background: linear-gradient(145deg, #ffffff 0%, #f8f6ff 100%); padding: 40px; margin:0; width:100%; max-width:none;">
      <div class="header">
        <div class="logo"><span class="icon">üå±</span>AgroStable</div>
        <div class="subtitle">An√°lisis Satelital Agr√≠cola Inteligente</div>
      </div>
      <form id="farm-form" style="width:100%; max-width:600px; margin:0 auto; display:block; background:none; box-shadow:none; padding:0; border-radius:0;">
        <div class="form-group">
          <label for="farm-name" data-translate="farmName">Nombre de la finca</label>
          <input type="text" id="farm-name" name="farm-name" required>
        </div>
        <div class="form-group">
          <label for="latitud" data-translate="latitude">Latitud</label>
          <input type="number" id="latitud" name="latitude" step="any" required>
        </div>
        <div class="form-group">
          <label for="longitud" data-translate="longitude">Longitud</label>
          <input type="number" id="longitud" name="longitude" step="any" required>
        </div>
        <div class="form-group">
          <label for="crop-type" data-translate="cropType">Tipo de cultivo</label>
          <select id="crop-type" name="crop-type" required>
            <option value="" data-translate="selectCrop">Seleccione...</option>
            <option value="Tomate">Tomate</option>
            <option value="Ma√≠z">Ma√≠z</option>
            <option value="Caf√©">Caf√©</option>
            <option value="Arroz">Arroz</option>
            <option value="Papa">Papa</option>
            <option value="Frijol">Frijol</option>
            <option value="Cebolla">Cebolla</option>
            <option value="Lechuga">Lechuga</option>
            <option value="Pl√°tano">Pl√°tano</option>
            <option value="Ca√±a de az√∫car">Ca√±a de az√∫car</option>
            <option value="Cacao">Cacao</option>
            <option value="Yuca">Yuca</option>
            <option value="Flores">Flores</option>
            <option value="Trigo">Trigo</option>
            <option value="Aguacate">Aguacate</option>
          </select>
        </div>
        <div class="form-actions" style="display:flex; gap:20px; margin-top:8px; justify-content:center;">
          <button type="submit" data-translate="analyzeFarm">Analizar Finca</button>
          <button type="button" id="clear-btn">Limpiar</button>
        </div>
      </form>
      <section id="resultados">
        <div id="result-map" style="height: 300px; border-radius: 12px; margin: 20px 0; display: none;"></div>
        <div id="resultados-lista"></div>
      </section>
    </div>
  </section>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const form = document.getElementById('farm-form');
    const resultados = document.getElementById('resultados');
    const resultadosLista = document.getElementById('resultados-lista');
    const clearBtn = document.getElementById('clear-btn');

    // ========== RANGOS POR DEFECTO ==========
    const RANGOS_POR_DEFECTO = {
      ndvi: [
        { estado: "CR√çTICO", min: 0.00, max: 0.19 },
        { estado: "MALO", min: 0.20, max: 0.39 },
        { estado: "REGULAR", min: 0.40, max: 0.59 },
        { estado: "BUENO", min: 0.60, max: 0.79 },
        { estado: "EXCELENTE", min: 0.80, max: 1.00 }
      ],
      temp: { min: 18, max: 26, opt: 22 },
      humedad: { min: 60, max: 80, opt: 70 }
    };
    let rangosCultivo = null;
    let rangosCultivoPromesa = null;
    // Consultar rangos din√°micos al seleccionar cultivo
    const cropTypeSelect = document.getElementById('crop-type');
    cropTypeSelect.addEventListener('change', async function() {
      const cultivo = cropTypeSelect.value;
      rangosCultivo = null;
      if (!cultivo) return;
      try {
        const resp = await fetch('http://localhost:3001/cultivo-rangos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cultivo })
        });
        if (resp.ok) {
          const result = await resp.json();
          if (result.success && result.data) {
            rangosCultivo = result.data;
          }
        }
      } catch (err) {
        console.error('Error consultando rangos de cultivo:', err);
      }
    });

    // ========== CLASIFICACI√ìN SUBSIDENCIA CONSISTENTE ==========
    function clasificarSubsidencia(valor) {
      const valorAbsoluto = Math.abs(valor);
      if (valorAbsoluto >= 0 && valorAbsoluto <= 1) {
        return {
          categoria: "ESTABLE",
          penalizacion: 0,
          descripcion: "Terreno firme y seguro"
        };
      }
      if (valorAbsoluto > 1 && valorAbsoluto <= 3) {
        return {
          categoria: "LIGERAMENTE INESTABLE",
          penalizacion: 10,
          descripcion: "Ligera inestabilidad del terreno"
        };
      }
      if (valorAbsoluto > 3 && valorAbsoluto <= 6) {
        return {
          categoria: "INESTABLE",
          penalizacion: 25,
          descripcion: "Terreno moderadamente inestable"
        };
      }
      if (valorAbsoluto > 6) {
        return {
          categoria: "CR√çTICO",
          penalizacion: 40,
          descripcion: "Terreno altamente inestable"
        };
      }
    }

    // ========== NUEVA FUNCI√ìN DE C√ÅLCULO DE PUNTUACI√ìN ==========
    function calcularPuntuacionFinal(penalizaciones) {
        // Sumar todas las penalizaciones
        let totalPenalizaciones = 0;
        let detalleCalculos = [];
        // NDVI
        if (penalizaciones.ndvi > 0) {
            totalPenalizaciones += penalizaciones.ndvi;
            detalleCalculos.push(`NDVI: -${penalizaciones.ndvi}`);
        }
        // Subsidencia  
        if (penalizaciones.subsidencia > 0) {
            totalPenalizaciones += penalizaciones.subsidencia;
            detalleCalculos.push(`Subsidencia: -${penalizaciones.subsidencia}`);
        }
        // Temperatura
        if (penalizaciones.temperatura > 0) {
            totalPenalizaciones += penalizaciones.temperatura;
            detalleCalculos.push(`Temperatura: -${penalizaciones.temperatura}`);
        }
        // Humedad
        if (penalizaciones.humedad > 0) {
            totalPenalizaciones += penalizaciones.humedad;
            detalleCalculos.push(`Humedad: -${penalizaciones.humedad}`);
        }
        // C√°lculo final
        const puntuacionFinal = Math.max(5, 100 - totalPenalizaciones);
        // Debug obligatorio
        console.log('=== C√ÅLCULO PUNTUACI√ìN ===');
        console.log('Penalizaciones individuales:', penalizaciones);
        console.log('Total penalizaciones:', totalPenalizaciones);
        console.log('Detalle:', detalleCalculos.join(', '));
        console.log('Puntuaci√≥n final: 100 -', totalPenalizaciones, '=', puntuacionFinal);
        console.log('========================');
        return {
            puntuacion: puntuacionFinal,
            totalPenalizaciones: totalPenalizaciones,
            detalle: detalleCalculos
        };
    }

    // FUNCI√ìN PARA INTERPRETAR DATOS DE AGROSTABLE CON RANGOS DIN√ÅMICOS
    function interpretarDatosAgricolas(ndvi, subsidencia, clima, cultivo, rangos) {
      // Usar rangos din√°micos si existen, si no, por defecto
      const r = rangos || RANGOS_POR_DEFECTO;
      // ========== INTERPRETACI√ìN NDVI ==========
      function interpretarNDVI(valor, cultivo) {
        let estado = "Sin datos", porcentaje = null, descripcion = "", calidad = "";
        if (valor === null || valor === undefined || valor < 0) {
          descripcion = "No hay suficientes im√°genes satelitales sin nubes en los √∫ltimos 30 d√≠as.";
          return { estado, porcentaje, descripcion, calidad };
        }
        let ndviRangos = r.ndvi || [
          { estado: "CR√çTICO", min: r.ndvi_critico_min ?? 0.00, max: r.ndvi_critico_max ?? 0.19 },
          { estado: "MALO", min: r.ndvi_malo_min ?? 0.20, max: r.ndvi_malo_max ?? 0.39 },
          { estado: "REGULAR", min: r.ndvi_regular_min ?? 0.40, max: r.ndvi_regular_max ?? 0.59 },
          { estado: "BUENO", min: r.ndvi_bueno_min ?? 0.60, max: r.ndvi_bueno_max ?? 0.79 },
          { estado: "EXCELENTE", min: r.ndvi_excelente_min ?? 0.80, max: r.ndvi_excelente_max ?? 1.00 }
        ];
        // Si los rangos vienen de Supabase, construir arreglo
        if (!r.ndvi && r.ndvi_critico_min !== undefined) {
          ndviRangos = [
            { estado: "CR√çTICO", min: r.ndvi_critico_min, max: r.ndvi_critico_max },
            { estado: "MALO", min: r.ndvi_malo_min, max: r.ndvi_malo_max },
            { estado: "REGULAR", min: r.ndvi_regular_min, max: r.ndvi_regular_max },
            { estado: "BUENO", min: r.ndvi_bueno_min, max: r.ndvi_bueno_max },
            { estado: "EXCELENTE", min: r.ndvi_excelente_min, max: r.ndvi_excelente_max }
          ];
        }
        for (const rango of ndviRangos) {
          if (valor >= rango.min && valor <= rango.max) {
            estado = rango.estado;
            break;
          }
        }
        porcentaje = Math.round(valor * 100);
        if (estado === "EXCELENTE") calidad = "alta";
        else if (estado === "BUENO") calidad = "media-alta";
        else if (estado === "REGULAR") calidad = "media";
        else if (estado === "MALO") calidad = "baja";
        else if (estado === "CR√çTICO") calidad = "cr√≠tica";
        descripcion = `Tu plantaci√≥n de ${cultivo} est√° en estado ${estado.toLowerCase()}.`;
        return { estado, porcentaje, descripcion, calidad };
      }
      // ========== INTERPRETACI√ìN SUBSIDENCIA ==========
      function interpretarSubsidencia(valor, cultivo) {
        if (valor === null || valor === undefined || isNaN(valor)) {
          return { estado: "Sin datos", descripcion: "No hay datos de subsidencia disponibles.", riesgo: "N/A", penalizacion: null };
        }
        const clasif = clasificarSubsidencia(valor);
        let descripcion = "";
        switch (clasif.categoria) {
          case "ESTABLE":
            descripcion = `Tu terreno es muy estable (${valor} mm/a√±o de hundimiento o elevaci√≥n). Excelente para ${cultivo}.`;
            break;
          case "LIGERAMENTE INESTABLE":
            descripcion = `Tu terreno tiene ligera inestabilidad (${valor} mm/a√±o). Aceptable para ${cultivo}.`;
            break;
          case "INESTABLE":
            descripcion = `Tu terreno presenta inestabilidad moderada (${valor} mm/a√±o). Riesgo para ${cultivo}.`;
            break;
          case "CR√çTICO":
            descripcion = `Tu terreno es altamente inestable (${valor} mm/a√±o). Riesgo alto para ${cultivo}.`;
            break;
        }
        let riesgo = clasif.categoria === "CR√çTICO" ? "Alto" : clasif.categoria === "INESTABLE" ? "Moderado" : clasif.categoria === "LIGERAMENTE INESTABLE" ? "Bajo" : "Muy bajo";
        return { estado: clasif.categoria, descripcion, riesgo, penalizacion: clasif.penalizacion };
      }
      // ========== RECOMENDACIONES INTELIGENTES ==========
      function generarRecomendaciones(ndviResult, subsidenciaResult, climaResult, cultivo) {
        let recomendaciones = [];
        if (ndviResult.estado === "Sin datos") {
          recomendaciones.push("No hay suficientes im√°genes satelitales sin nubes en los √∫ltimos 30 d√≠as. Repetir an√°lisis en unos d√≠as cuando haya im√°genes disponibles.");
        } else if (ndviResult.calidad === "cr√≠tica") {
          recomendaciones.push(`üö® URGENTE: Implementar riego de emergencia y revisar sistema de irrigaci√≥n PORQUE el NDVI cr√≠tico (${ndviResult.porcentaje}%) indica estr√©s h√≠drico severo.`);
          recomendaciones.push(`üíß Aplicar fertilizaci√≥n foliar rica en nitr√≥geno inmediatamente PORQUE el NDVI cr√≠tico (${ndviResult.porcentaje}%) sugiere deficiencia nutricional.`);
          recomendaciones.push(`üß™ Realizar an√°lisis de suelo para detectar deficiencias nutricionales PORQUE el NDVI cr√≠tico (${ndviResult.porcentaje}%) puede deberse a problemas de suelo.`);
          recomendaciones.push(`‚òÄÔ∏è Verificar sombreo si hay temperaturas extremas PORQUE el NDVI cr√≠tico (${ndviResult.porcentaje}%) puede estar relacionado con estr√©s t√©rmico.`);
          recomendaciones.push("Si no hay mejora en 2-3 semanas, considerar replantaci√≥n parcial de zonas m√°s afectadas.");
        } else if (ndviResult.calidad === "baja") {
          recomendaciones.push(`üíä Aplicar fertilizaci√≥n foliar PORQUE el NDVI bajo (${ndviResult.porcentaje}%) indica posible deficiencia nutricional.`);
          recomendaciones.push(`üåø Manejo integrado de plagas y enfermedades PORQUE el NDVI bajo (${ndviResult.porcentaje}%) puede estar asociado a da√±o por plagas o enfermedades.`);
          if (climaResult && climaResult.temp > 0) {
            if (climaResult.temp > 30) {
              recomendaciones.push(`üíß Aumentar frecuencia de riego PORQUE la temperatura alta (${climaResult.temp}¬∞C) genera estr√©s t√©rmico.`);
            } else if (climaResult.temp < 15) {
              recomendaciones.push(`‚òÄÔ∏è Mejorar exposici√≥n solar PORQUE la temperatura baja (${climaResult.temp}¬∞C) puede limitar el crecimiento.`);
            } else {
              recomendaciones.push(`üíß Optimizar frecuencia de riego PORQUE el NDVI bajo (${ndviResult.porcentaje}%) puede estar relacionado con el riego.`);
            }
          } else {
            recomendaciones.push(`üíß Optimizar frecuencia de riego PORQUE el NDVI bajo (${ndviResult.porcentaje}%) puede estar relacionado con el riego.`);
          }
        } else if (ndviResult.calidad === "media") {
          recomendaciones.push(`üå± Fertilizaci√≥n de mantenimiento PORQUE el NDVI regular (${ndviResult.porcentaje}%) indica vegetaci√≥n moderada.`);
          recomendaciones.push(`üëÄ Monitoreo semanal del cultivo para detectar cambios en NDVI y clima.`);
        } else if (ndviResult.calidad === "media-alta" || ndviResult.calidad === "alta") {
          recomendaciones.push(`‚úÖ Mantener pr√°cticas actuales PORQUE el NDVI es bueno/excelente (${ndviResult.porcentaje}%).`);
          recomendaciones.push(`üìä Monitoreo mensual preventivo para asegurar estabilidad.`);
        }
        if (subsidenciaResult.riesgo === "Alto") {
          recomendaciones.push(`‚ö†Ô∏è Revisar sistema de riego por posibles rupturas PORQUE la subsidencia es alta (terreno inestable).`);
        }
        return recomendaciones.slice(0, 5);
      }
      // ========== EJECUTAR ==========
      const ndviResult = interpretarNDVI(ndvi, cultivo);
      const subsidenciaResult = interpretarSubsidencia(subsidencia, cultivo);
      const recomendaciones = generarRecomendaciones(ndviResult, subsidenciaResult, clima, cultivo);

      // ================= NUEVO C√ÅLCULO DE PENALIZACIONES Y PUNTUACI√ìN =================
      // 1. Penalizaci√≥n NDVI
      let penalNDVI = null;
      if (ndviResult && ndviResult.estado && ndviResult.estado.toUpperCase() !== 'SIN DATOS' && ndviResult.estado.toUpperCase() !== 'NULL') {
        switch (ndviResult.estado.toUpperCase()) {
          case 'CR√çTICO': penalNDVI = 30; break;
          case 'MALO': penalNDVI = 18; break;
          case 'REGULAR': penalNDVI = 10; break;
          case 'BUENO': penalNDVI = 3; break;
          case 'EXCELENTE': penalNDVI = 0; break;
        }
      }
      // 2. Penalizaci√≥n Subsidencia
      let penalSubs = null;
      if (subsidenciaResult && subsidenciaResult.estado && subsidenciaResult.estado.toUpperCase() !== 'SIN DATOS' && subsidenciaResult.estado.toUpperCase() !== 'NULL') {
        penalSubs = subsidenciaResult.penalizacion;
      }
      // 3. Penalizaci√≥n Temperatura
      let penalTemp = 0;
      if (clima && typeof clima.temp === 'number') {
        let tempMin = (typeof r.temp_minima === 'number') ? r.temp_minima : (r.temp ? r.temp.min : 18);
        let tempMax = (typeof r.temp_maxima === 'number') ? r.temp_maxima : (r.temp ? r.temp.max : 26);
        if (clima.temp < tempMin) {
          penalTemp = Math.min(20, 4 * Math.ceil((tempMin - clima.temp) / 2));
        } else if (clima.temp > tempMax) {
          penalTemp = Math.min(20, 4 * Math.ceil((clima.temp - tempMax) / 2));
        } else {
          penalTemp = 0;
        }
      }
      // 4. Penalizaci√≥n Humedad
      let penalHum = 0;
      if (clima && typeof clima.humidity === 'number') {
        let humMin = (typeof r.humedad_minima === 'number') ? r.humedad_minima : (r.humedad ? r.humedad.min : 60);
        let humMax = (typeof r.humedad_maxima === 'number') ? r.humedad_maxima : (r.humedad ? r.humedad.max : 80);
        if (clima.humidity < humMin) {
          penalHum = Math.min(15, 3 * Math.ceil((humMin - clima.humidity) / 5));
        } else if (clima.humidity > humMax) {
          penalHum = Math.min(15, 3 * Math.ceil((clima.humidity - humMax) / 5));
        } else {
          penalHum = 0;
        }
      }
      // Usar la nueva funci√≥n de c√°lculo de puntuaci√≥n
      const penalizacionesObj = {
        ndvi: penalNDVI || 0,
        subsidencia: penalSubs || 0,
        temperatura: penalTemp || 0,
        humedad: penalHum || 0
      };
      const resultadoPunt = calcularPuntuacionFinal(penalizacionesObj);
      let puntuacion = resultadoPunt.puntuacion;
      const totalPenal = resultadoPunt.totalPenalizaciones;
      const detallePenal = resultadoPunt.detalle;
      // Nivel
      let nivel = "";
      if (puntuacion >= 80) nivel = "EXCELENTE";
      else if (puntuacion >= 60) nivel = "BUENO";
      else if (puntuacion >= 40) nivel = "REGULAR";
      else if (puntuacion >= 20) nivel = "RIESGO MEDIO";
      else nivel = "REQUIERE ATENCI√ìN URGENTE";
      // Solo sumar penalizaciones de factores con datos
      const penalizaciones = [
        { categoria: 'NDVI', puntos: penalNDVI },
        { categoria: 'Subsidencia', puntos: penalSubs },
        { categoria: 'Temperatura', puntos: penalTemp },
        { categoria: 'Humedad', puntos: penalHum }
      ];
      const factoresConDatos = penalizaciones.filter(p => p.puntos !== null);
      const esParcial = factoresConDatos.length < 4;
      return {
        ndvi: ndviResult,
        subsidencia: subsidenciaResult,
        recomendaciones: recomendaciones,
        puntuacion: { puntuacion, nivel, esParcial, detallePenal },
        penalizaciones: penalizaciones,
        clima,
        cultivo,
        rangos: r
      };
    }

    // ================= SISTEMA DE EXPLICACI√ìN AUTOM√ÅTICA DE PUNTUACI√ìN =================
    function explicarPuntuacionGeneral({ ndvi, subsidencia, clima, cultivo, rangos, puntuacion, penalizaciones }) {
      let r = rangos || RANGOS_POR_DEFECTO;
      let tempMin = (typeof r.temp_minima === 'number') ? r.temp_minima : (r.temp ? r.temp.min : 18);
      let tempMax = (typeof r.temp_maxima === 'number') ? r.temp_maxima : (r.temp ? r.temp.max : 26);
      let humMin = (typeof r.humedad_minima === 'number') ? r.humedad_minima : (r.humedad ? r.humedad.min : 60);
      let humMax = (typeof r.humedad_maxima === 'number') ? r.humedad_maxima : (r.humedad ? r.humedad.max : 80);
      // NDVI
      let ndviPenal = penalizaciones.find(p => p.categoria === 'NDVI')?.puntos ?? 0;
      let ndviEstado = ndvi?.estado || 'Sin datos';
      let ndviExp = ndvi && ndvi.estado ?
        (ndvi.estado.toUpperCase() === 'SIN DATOS' ? `Datos no disponibles por condiciones clim√°ticas.` :
        ndvi.estado.toUpperCase() === 'CR√çTICO' ? `Vegetaci√≥n muy escasa o suelo desnudo para ${cultivo}.` :
        ndvi.estado.toUpperCase() === 'MALO' ? `Vegetaci√≥n escasa, riesgo de bajo rendimiento.` :
        ndvi.estado.toUpperCase() === 'REGULAR' ? `Vegetaci√≥n moderada, necesita mejoras.` :
        ndvi.estado.toUpperCase() === 'BUENO' ? `Vegetaci√≥n saludable, margen de mejora.` :
        `Vegetaci√≥n densa y saludable para ${cultivo}.`) : 'Sin datos.';
      // Subsidencia
      let subPenal = penalizaciones.find(p => p.categoria === 'Subsidencia')?.puntos ?? 0;
      let subEstado = subsidencia?.estado || 'Sin datos';
      let subExp = subsidencia && subsidencia.estado ?
        (subsidencia.estado.toUpperCase() === 'CR√çTICO' ? `Terreno inestable amenaza la infraestructura.` :
        subsidencia.estado.toUpperCase() === 'INESTABLE' ? `Riesgo moderado de hundimiento.` :
        subsidencia.estado.toUpperCase() === 'LIGERAMENTE INESTABLE' ? `Ligera inestabilidad del terreno.` :
        subsidencia.estado.toUpperCase() === 'ESTABLE' ? `Terreno firme y seguro.` :
        'Sin datos.') : 'Sin datos.';
      // Temperatura
      let tempPenal = penalizaciones.find(p => p.categoria === 'Temperatura')?.puntos ?? 0;
      let tempEstado = 'Sin datos';
      let tempExp = 'Sin datos.';
      if (clima && typeof clima.temp === 'number') {
        if (clima.temp < tempMin) {
          tempEstado = 'Baja';
          tempExp = `${clima.temp}¬∞C est√° por debajo del rango √≥ptimo para ${cultivo} (${tempMin}-${tempMax}¬∞C).`;
        } else if (clima.temp > tempMax) {
          tempEstado = 'Alta';
          tempExp = `${clima.temp}¬∞C est√° muy por encima del rango √≥ptimo para ${cultivo} (${tempMin}-${tempMax}¬∞C).`;
        } else {
          tempEstado = 'Ideal';
          tempExp = `${clima.temp}¬∞C en el rango √≥ptimo para ${cultivo}.`;
        }
      }
      // Humedad
      let humPenal = penalizaciones.find(p => p.categoria === 'Humedad')?.puntos ?? 0;
      let humEstado = 'Sin datos';
      let humExp = 'Sin datos.';
      if (clima && typeof clima.humidity === 'number') {
        if (clima.humidity < humMin) {
          humEstado = 'Baja';
          humExp = `${clima.humidity}% est√° por debajo del rango √≥ptimo para ${cultivo} (${humMin}-${humMax}%).`;
        } else if (clima.humidity > humMax) {
          humEstado = 'Alta';
          humExp = `${clima.humidity}% est√° por encima del rango √≥ptimo para ${cultivo} (${humMin}-${humMax}%).`;
        } else {
          humEstado = 'Ideal';
          humExp = `${clima.humidity}% en el rango √≥ptimo para ${cultivo}.`;
        }
      }
      // T√≠tulo y lista
      return `
        <b>¬øPor qu√© esta puntuaci√≥n?</b>
        <ul style='margin:0.3em 0 0.3em 1.2em;'>
          <li><b>NDVI ${ndviEstado}</b> (-${ndviPenal} puntos): ${ndviExp}</li>
          <li><b>Subsidencia ${subEstado}</b> (-${subPenal} puntos): ${subExp}</li>
          <li><b>Temperatura ${tempEstado}</b> (-${tempPenal} puntos): ${tempExp}</li>
          <li><b>Humedad ${humEstado}</b> (-${humPenal} puntos): ${humExp}</li>
        </ul>
      `;
    }

    // ========== LEAFLET MAPA DE RESULTADO ==========
    let resultMap = null;
    let resultMarker = null;
    function mostrarMapaResultado(lat, lng) {
      const mapDiv = document.getElementById('result-map');
      mapDiv.style.display = 'block';
      mapDiv.innerHTML = '';
      // T√≠tulo sobre el mapa
      if (!document.getElementById('result-map-title')) {
        const title = document.createElement('div');
        title.id = 'result-map-title';
        title.textContent = 'üìç Ubicaci√≥n Analizada';
        title.style.fontWeight = '600';
        title.style.fontSize = '18px';
        title.style.marginBottom = '8px';
        mapDiv.parentNode.insertBefore(title, mapDiv);
      }
      // Inicializar mapa
      resultMap = L.map('result-map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(resultMap);
      resultMarker = L.marker([lat, lng]).addTo(resultMap);
    }

    // ========== FIX: USAR SIEMPRE LOS CAMPOS latitud/longitud PARA AN√ÅLISIS ==========
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      try {
        // Validaci√≥n manual
        const nombre = document.getElementById('farm-name').value.trim();
        const lat = document.getElementById('latitud').value.trim();
        const lon = document.getElementById('longitud').value.trim();
        const cultivo = document.getElementById('crop-type').value;
        if (!nombre || !lat || !lon || !cultivo) {
          alert('Por favor, complete todos los campos.');
          return;
        }
        resultadosLista.innerHTML = '<li>Consultando clima y subsidencia...</li>';
        resultados.style.display = 'block';
        // Consultar clima a trav√©s del backend
        let temp = null;
        let humidity = null;
        let climaInfo = '';
        let climaApiError = false;
        try {
          const resp = await fetch('http://localhost:3001/clima', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: parseFloat(lat), lon: parseFloat(lon) })
          });
          if (!resp.ok) throw new Error('Error al consultar el clima');
          const result = await resp.json();
          if (!result.success || !result.data) throw new Error('Respuesta inv√°lida de /clima');
          const data = result.data;
          temp = (data.main && typeof data.main.temp === 'number') ? data.main.temp : null;
          humidity = (data.main && typeof data.main.humidity === 'number') ? data.main.humidity : null;
          const weather = data.weather?.[0]?.description;
          const wind = data.wind?.speed;
          climaInfo = `üå°Ô∏è <b>Condiciones clim√°ticas:</b> ${weather ? weather.charAt(0).toUpperCase() + weather.slice(1) : 'N/A'}, ${temp !== null ? temp + '¬∞C' : ''} (Humedad: ${humidity !== null ? humidity + '%' : 'N/A'}, Viento: ${wind ?? 'N/A'} m/s)`;
        } catch (err) {
          console.error('Error al consultar clima:', err);
          climaInfo = 'Error al consultar clima.';
          temp = null;
          humidity = null;
          climaApiError = true;
        }
        // Consultar NDVI real del backend
        let ndviValue = null;
        let ndviFecha = null;
        let ndviApiError = false;
        try {
          const ndviResp = await fetch('http://localhost:3001/ndvi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: parseFloat(lat), lon: parseFloat(lon) })
          });
          if (!ndviResp.ok) throw new Error('Error al consultar NDVI');
          const ndviData = await ndviResp.json();
          if (ndviData.success && ndviData.data && ndviData.data.ndvi !== null) {
            ndviValue = ndviData.data.ndvi;
            ndviFecha = ndviData.data.fecha;
          } else if (ndviData.success && ndviData.data && ndviData.data.ndvi === null) {
            ndviValue = null;
          } else {
            ndviApiError = true;
          }
        } catch (err) {
          console.error('Error al consultar NDVI:', err);
          ndviApiError = true;
          ndviValue = null;
        }
        // Consultar subsidencia real del backend
        let subsidenciaValor = null;
        let subsidenciaApiError = false;
        try {
          const subsResp = await fetch('http://localhost:3001/subsidence', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: parseFloat(lat), lon: parseFloat(lon) })
          });
          if (subsResp.ok) {
            const subsData = await subsResp.json();
            if (subsData.success && subsData.data.hasData) {
              subsidenciaValor = subsData.data.value;
            } else if (subsData.success && !subsData.data.hasData) {
              subsidenciaValor = null;
            } else {
              subsidenciaApiError = true;
            }
          } else {
            subsidenciaApiError = true;
          }
        } catch (err) {
          console.error('Error al consultar subsidencia:', err);
          subsidenciaApiError = true;
          subsidenciaValor = null;
        }
        // Obtener rangos din√°micos del cultivo seleccionado
        let rangos = rangosCultivo;
        if (!rangos) {
          // Si no se consult√≥ antes, intentar consultar ahora
          try {
            const resp = await fetch('http://localhost:3001/cultivo-rangos', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cultivo })
            });
            if (resp.ok) {
              const result = await resp.json();
              if (result.success && result.data) {
                rangos = result.data;
              }
            }
          } catch (err) {
            console.error('Error consultando rangos de cultivo en submit:', err);
          }
        }
        // Usar la funci√≥n de interpretaci√≥n avanzada con rangos din√°micos
        const resultado = interpretarDatosAgricolas(ndviValue, subsidenciaValor, { temp, humidity }, cultivo, rangos);
        // Mostrar advertencia si alguna API fall√≥
        let advertencias = [];
        if (ndviApiError) advertencias.push('‚ö†Ô∏è No se pudo obtener el NDVI por un error en el servidor.');
        if (subsidenciaApiError) advertencias.push('‚ö†Ô∏è No se pudo obtener la subsidencia por un error en el servidor.');
        if (climaApiError) advertencias.push('‚ö†Ô∏è No se pudo obtener el clima por un error en el servidor.');

        // An√°lisis clim√°tico espec√≠fico por cultivo
        function analizarClimaPorCultivo(temp, humedad, condiciones, cultivo, rangos) {
          // Usar rangos din√°micos si existen, si no, por defecto
          let r = rangos || RANGOS_POR_DEFECTO;
          // CORREGIDO: Usar exactamente temp_minima y temp_maxima si existen
          let tempMin = (typeof r.temp_minima === 'number') ? r.temp_minima : (r.temp ? r.temp.min : 18);
          let tempMax = (typeof r.temp_maxima === 'number') ? r.temp_maxima : (r.temp ? r.temp.max : 26);
          let humedadMin = (typeof r.humedad_minima === 'number') ? r.humedad_minima : (r.humedad ? r.humedad.min : 60);
          let humedadMax = (typeof r.humedad_maxima === 'number') ? r.humedad_maxima : (r.humedad ? r.humedad.max : 80);
          let tempMsg = '', humedadMsg = '', condMsg = '';
          if (typeof temp === 'number') {
            if (temp < tempMin) tempMsg = `Temperatura: ${temp}¬∞C - BAJA para ${cultivo} (ideal: ${tempMin}-${tempMax}¬∞C). Puede causar estr√©s por fr√≠o.`;
            else if (temp > tempMax) tempMsg = `Temperatura: ${temp}¬∞C - ALTA para ${cultivo} (ideal: ${tempMin}-${tempMax}¬∞C). Puede causar estr√©s t√©rmico.`;
            else tempMsg = `Temperatura: ${temp}¬∞C - IDEAL para ${cultivo} (ideal: ${tempMin}-${tempMax}¬∞C).`;
          }
          if (typeof humedad === 'number') {
            if (humedad < humedadMin) humedadMsg = `Humedad: ${humedad}% - BAJA para ${cultivo} (ideal: ${humedadMin}-${humedadMax}%). Necesita m√°s riego.`;
            else if (humedad > humedadMax) humedadMsg = `Humedad: ${humedad}% - ALTA para ${cultivo} (ideal: ${humedadMin}-${humedadMax}%). Riesgo de hongos.`;
            else humedadMsg = `Humedad: ${humedad}% - IDEAL para ${cultivo}.`;
          }
          // Eliminar la l√≠nea redundante de condiciones tipo 'Condiciones: XX¬∞C'
          if (condiciones) {
            if (condiciones.toLowerCase().includes('nube')) condMsg = `Condiciones: ${condiciones.charAt(0).toUpperCase() + condiciones.slice(1)} - BUENAS para fotos√≠ntesis.`;
            else if (condiciones.toLowerCase().includes('lluvia')) condMsg = `Condiciones: ${condiciones.charAt(0).toUpperCase() + condiciones.slice(1)} - Precauci√≥n por exceso de agua.`;
            // Eliminar cualquier condici√≥n que sea solo temperatura (ej: '31¬∞C', '37.6¬∞C', etc.)
            else if (!/^\s*-?\d+(\.\d+)?\s*¬∞c\s*\.?$/i.test(condiciones)) condMsg = `Condiciones: ${condiciones.charAt(0).toUpperCase() + condiciones.slice(1)}.`;
          }
          // Solo mostrar mensajes no redundantes
          return `<div style='margin-top:0.7em;'><b>An√°lisis clim√°tico para ${cultivo}:</b><ul style='margin:0.3em 0 0.3em 1.2em;'>${[tempMsg, humedadMsg, condMsg].filter(Boolean).map(m=>`<li>${m}</li>`).join('')}</ul></div>`;
        }

        // Extraer condiciones para an√°lisis clim√°tico
        let weatherDesc = '';
        try {
          const weatherMatch = /Condiciones clim√°ticas:\/b?([^,]*)/i.exec(climaInfo);
          if (weatherMatch && weatherMatch[1]) weatherDesc = weatherMatch[1].trim();
        } catch {}
        if (!weatherDesc && climaInfo) {
          const m = /Condiciones clim√°ticas:[^,]*, ([^\(]*)/i.exec(climaInfo);
          if (m && m[1]) weatherDesc = m[1].trim();
        }
        const climaAnalisis = analizarClimaPorCultivo(temp, humidity, weatherDesc, cultivo, rangos);

        // Mostrar resultados en la UI con explicaciones educativas y an√°lisis clim√°tico
        resultadosLista.innerHTML = `
          <li><b>üå± NDVI:</b> ${ndviValue !== null && ndviValue !== undefined ? ndviValue.toFixed(2) + ' (' + resultado.ndvi.porcentaje + '%)' : 'N/A'} - <b>${resultado.ndvi.estado}</b><br>${resultado.ndvi.descripcion}
            <div style="margin-top:0.7em;">
              <b>¬øQu√© significa esto?</b><br>
              El NDVI (√çndice de Vegetaci√≥n de Diferencia Normalizada) indica el vigor y salud de la vegetaci√≥n. Valores altos significan plantas sanas y densas; valores bajos indican estr√©s, escasez o muerte vegetal.
            </div>
            <div style="margin-top:0.7em;">
              <b>¬øDe d√≥nde sale este dato?</b><br>
              Analizamos tu finca con m√∫ltiples im√°genes satelitales (Sentinel-2) de los √∫ltimos 30 d√≠as que miden el "verdor" de las plantas usando bandas del espectro visible e infrarrojo. Calculamos el NDVI promedio para obtener un resultado m√°s preciso y estable, filtrando im√°genes con nubes.
            </div>
            <div style="margin-top:0.7em;">
              <b>Rangos NDVI para ${cultivo}:</b><br>
              <ul style="margin:0.3em 0 0.3em 1.2em;">
                <li>0.80 - 1.00: Excelente (vegetaci√≥n densa)</li>
                <li>0.60 - 0.79: Bueno (vegetaci√≥n saludable)</li>
                <li>0.40 - 0.59: Regular (estr√©s moderado)</li>
                <li>0.20 - 0.39: Malo (estr√©s severo)</li>
                <li>0.00 - 0.19: Cr√≠tico (suelo desnudo o vegetaci√≥n muerta)</li>
              </ul>
            </div>
          </li>
          <li>${climaInfo || 'üå°Ô∏è <b>Condiciones clim√°ticas:</b> N/A'}${climaAnalisis}</li>
          <li><b>üèîÔ∏è Subsidencia:</b> ${resultado.subsidencia.estado}<br>${resultado.subsidencia.descripcion}
            <div style="margin-top:0.7em;">
              <b>¬øQu√© es subsidencia?</b><br>
              La subsidencia es el hundimiento gradual del terreno, que puede afectar la estabilidad de cultivos y estructuras agr√≠colas.
            </div>
            <div style="margin-top:0.7em;">
              <b>¬øC√≥mo lo medimos?</b><br>
              Usamos radares satelitales (Sentinel-1) que detectan cambios milim√©tricos en la altura del suelo a lo largo del tiempo, permitiendo identificar zonas estables o con riesgo de hundimiento.
            </div>
            <div style="margin-top:0.7em;">
              <b>Rangos de subsidencia:</b><br>
              <ul style="margin:0.3em 0 0.3em 1.2em;">
                <li>0-1 mm/a√±o: Estable</li>
                <li>1-3 mm/a√±o: Ligeramente inestable</li>
                <li>3-6 mm/a√±o: Inestable</li>
                <li>>6 mm/a√±o: Cr√≠tico</li>
              </ul>
            </div>
          </li>
          <li><b>üéØ Recomendaciones:</b><ul style="margin:0; padding-left:1.2em;">${resultado.recomendaciones.map(r => `<li>${r}</li>`).join('')}</ul></li>
          <li><b>üìà Puntuaci√≥n general:</b> ${resultado.puntuacion.puntuacion}/100 (${resultado.puntuacion.nivel})</li>
          ${resultado.puntuacion.esParcial ? `<li style="color:#b71c1c;"><b>Puntuaci√≥n parcial:</b> basada solo en los datos disponibles (algunos factores no se evaluaron por falta de informaci√≥n)</li>` : ''}
          ${advertencias.length > 0 ? `<li style="color:#b71c1c;">${advertencias.join('<br>')}</li>` : ''}
          <li style="margin-top:0.3em;">
            <span id="explicacion-puntuacion">${explicarPuntuacionGeneral({
              ndvi: resultado.ndvi,
              subsidencia: resultado.subsidencia,
              clima: { temp, humidity },
              cultivo,
              rangos,
              puntuacion: resultado.puntuacion.puntuacion,
              penalizaciones: resultado.penalizaciones
            })}</span>
          </li>
          <li style="margin-top:1.5em;">
            <b>üìö GLOSARIO:</b><br>
            <ul style="margin:0.3em 0 0.3em 1.2em;">
              <li><b>NDVI:</b> √çndice de Vegetaci√≥n que mide el verdor y salud de las plantas (0-1, m√°s alto = m√°s sano).</li>
              <li><b>Subsidencia:</b> Hundimiento gradual del terreno, medido en mil√≠metros por a√±o.</li>
              <li><b>Sentinel-2:</b> Sat√©lite europeo que provee im√°genes multiespectrales para agricultura y medio ambiente.</li>
              <li><b>Sentinel-1:</b> Sat√©lite radar que detecta cambios en la superficie terrestre, √∫til para monitorear subsidencia.</li>
              <li><b>Estabilidad del suelo:</b> Firmeza del terreno, importante para evitar da√±os en cultivos y estructuras.</li>
              <li><b>Rangos NDVI:</b> Valores de referencia para interpretar la salud vegetal seg√∫n el tipo de cultivo.</li>
            </ul>
          </li>
        `;
        resultados.style.display = 'block';
        resultados.scrollIntoView({behavior:'smooth'});
        // Mostrar mapa de resultado
        if (!isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon))) {
          mostrarMapaResultado(parseFloat(lat), parseFloat(lon));
        }
      } catch (err) {
        console.error('Error en el an√°lisis:', err);
        resultadosLista.innerHTML = '<li>Error al consultar el clima o subsidencia. Intenta de nuevo m√°s tarde.</li>';
      }
    });

    // Limpiar formulario y ocultar resultados
    clearBtn.addEventListener('click', function() {
      form.reset();
      resultados.style.display = 'none';
      resultadosLista.innerHTML = '';
    });
  </script>
  <script>
  const translations = {
      es: {
          heroTitle: "AgroStable - An√°lisis Satelital Agr√≠cola Inteligente",
          heroSubtitle: "Previene p√©rdidas en tu cultivo con datos satelitales en tiempo real",
          heroDescription: "Analiza la salud de tu plantaci√≥n, condiciones clim√°ticas y estabilidad del suelo usando tecnolog√≠a espacial de √∫ltima generaci√≥n",
          heroButton: "Analizar mi finca gratis",
          whatAnalyze: "¬øQu√© analizamos en tu finca?",
          ndviTitle: "NDVI - Salud de Plantas",
          ndviDesc: "Usando im√°genes multiespectrales de Sentinel-2, medimos la reflectancia infrarroja de tus cultivos. Valores altos indican vegetaci√≥n densa y saludable, mientras valores bajos revelan estr√©s h√≠drico, deficiencias nutricionales, plagas o enfermedades. Nuestro algoritmo compara tu NDVI con rangos √≥ptimos espec√≠ficos para cada cultivo.",
          climateTitle: "Condiciones Clim√°ticas",
          climateDesc: "Datos meteorol√≥gicos actualizados cada hora desde estaciones globales: temperatura ambiente, humedad relativa, velocidad del viento y condiciones atmosf√©ricas. Evaluamos si tu microclima actual favorece el crecimiento de tu cultivo espec√≠fico seg√∫n par√°metros agron√≥micos establecidos.",
          soilTitle: "Estabilidad del Suelo",
          soilDesc: "Tecnolog√≠a radar de apertura sint√©tica (SAR) de Sentinel-1 detecta movimientos milim√©tricos del terreno. Medimos subsidencia, expansi√≥n del suelo y microdeformaciones que pueden afectar sistemas de riego, estructuras agr√≠colas y desarrollo radicular de tus plantas.",
          howWorks: "Tecnolog√≠a satelital al servicio de tu finca",
          step1: "Ingresa las coordenadas de tu finca",
          step2: "Nuestros algoritmos consultan sat√©lites Sentinel en tiempo real",
          step3: "Recibes an√°lisis detallado con recomendaciones espec√≠ficas",
          step4: "Visualiza la ubicaci√≥n analizada en mapa interactivo",
          coverage: "Cobertura: Mundial",
          resolution: "Resoluci√≥n: hasta 10 metros",
          crops: "15 cultivos soportados",
          speed: "An√°lisis en menos de 30 segundos",
          cropsTitle: "Cultivos analizados",
          analyzeFarm: "Analizar Finca",
          farmName: "Nombre de la finca",
          latitude: "Latitud",
          longitude: "Longitud",
          cropType: "Tipo de cultivo",
          selectCrop: "Seleccione..."
      },
      en: {
          heroTitle: "AgroStable - Intelligent Agricultural Satellite Analysis",
          heroSubtitle: "Prevent crop losses with real-time satellite data",
          heroDescription: "Analyze your plantation's health, weather conditions, and soil stability using cutting-edge space technology",
          heroButton: "Analyze my farm for free",
          whatAnalyze: "What do we analyze on your farm?",
          ndviTitle: "NDVI - Plant Health",
          ndviDesc: "Using Sentinel-2 multispectral images, we measure the infrared reflectance of your crops. High values indicate dense, healthy vegetation, while low values reveal water stress, nutritional deficiencies, pests, or diseases. Our algorithm compares your NDVI to optimal ranges for each crop.",
          climateTitle: "Weather Conditions",
          climateDesc: "Weather data updated hourly from global stations: air temperature, relative humidity, wind speed, and atmospheric conditions. We assess if your current microclimate favors the growth of your specific crop according to agronomic parameters.",
          soilTitle: "Soil Stability",
          soilDesc: "Synthetic aperture radar (SAR) technology from Sentinel-1 detects millimetric ground movements. We measure subsidence, soil expansion, and micro-deformations that can affect irrigation systems, agricultural structures, and root development.",
          howWorks: "Satellite technology at your farm's service",
          step1: "Enter your farm's coordinates",
          step2: "Our algorithms query Sentinel satellites in real time",
          step3: "You receive a detailed analysis with specific recommendations",
          step4: "View the analyzed location on an interactive map",
          coverage: "Coverage: Worldwide",
          resolution: "Resolution: up to 10 meters",
          crops: "15 crops supported",
          speed: "Analysis in less than 30 seconds",
          cropsTitle: "Analyzed crops",
          analyzeFarm: "Analyze Farm",
          farmName: "Farm name",
          latitude: "Latitude",
          longitude: "Longitude",
          cropType: "Crop type",
          selectCrop: "Select..."
      },
      pt: {
          heroTitle: "AgroStable - An√°lise Satelital Agr√≠cola Inteligente",
          heroSubtitle: "Previna perdas na sua cultura com dados satelitais em tempo real",
          heroDescription: "Analise a sa√∫de da sua planta√ß√£o, condi√ß√µes clim√°ticas e estabilidade do solo usando tecnologia espacial de √∫ltima gera√ß√£o",
          heroButton: "Analisar minha fazenda gr√°tis",
          whatAnalyze: "O que analisamos na sua fazenda?",
          ndviTitle: "NDVI - Sa√∫de das Plantas",
          ndviDesc: "Usando imagens multiespectrais do Sentinel-2, medimos a reflet√¢ncia infravermelha das suas culturas. Valores altos indicam vegeta√ß√£o densa e saud√°vel, enquanto valores baixos revelam estresse h√≠drico, defici√™ncias nutricionais, pragas ou doen√ßas. Nosso algoritmo compara seu NDVI com faixas ideais para cada cultura.",
          climateTitle: "Condi√ß√µes Clim√°ticas",
          climateDesc: "Dados meteorol√≥gicos atualizados a cada hora de esta√ß√µes globais: temperatura do ar, umidade relativa, velocidade do vento e condi√ß√µes atmosf√©ricas. Avaliamos se o seu microclima atual favorece o crescimento da sua cultura espec√≠fica de acordo com par√¢metros agron√¥micos.",
          soilTitle: "Estabilidade do Solo",
          soilDesc: "Tecnologia de radar de abertura sint√©tica (SAR) do Sentinel-1 detecta movimentos milim√©tricos do solo. Medimos subsid√™ncia, expans√£o do solo e microdeforma√ß√µes que podem afetar sistemas de irriga√ß√£o, estruturas agr√≠colas e desenvolvimento radicular.",
          howWorks: "Tecnologia satelital a servi√ßo da sua fazenda",
          step1: "Insira as coordenadas da sua fazenda",
          step2: "Nossos algoritmos consultam sat√©lites Sentinel em tempo real",
          step3: "Voc√™ recebe uma an√°lise detalhada com recomenda√ß√µes espec√≠ficas",
          step4: "Visualize o local analisado em um mapa interativo",
          coverage: "Cobertura: Mundial",
          resolution: "Resolu√ß√£o: at√© 10 metros",
          crops: "15 culturas suportadas",
          speed: "An√°lise em menos de 30 segundos",
          cropsTitle: "Culturas analisadas",
          analyzeFarm: "Analisar Fazenda",
          farmName: "Nome da fazenda",
          latitude: "Latitude",
          longitude: "Longitude",
          cropType: "Tipo de cultura",
          selectCrop: "Selecione..."
      },
      fr: {
          heroTitle: "AgroStable - Analyse Satellitaire Agricole Intelligente",
          heroSubtitle: "Pr√©venez les pertes de r√©coltes avec des donn√©es satellitaires en temps r√©el",
          heroDescription: "Analysez la sant√© de votre plantation, les conditions climatiques et la stabilit√© du sol gr√¢ce √† la technologie spatiale de derni√®re g√©n√©ration",
          heroButton: "Analyser ma ferme gratuitement",
          whatAnalyze: "Que analysons-nous sur votre ferme ?",
          ndviTitle: "NDVI - Sant√© des Plantes",
          ndviDesc: "√Ä l'aide d'images multispectrales Sentinel-2, nous mesurons la r√©flectance infrarouge de vos cultures. Des valeurs √©lev√©es indiquent une v√©g√©tation dense et saine, tandis que des valeurs faibles r√©v√®lent un stress hydrique, des carences nutritionnelles, des ravageurs ou des maladies. Notre algorithme compare votre NDVI aux plages optimales pour chaque culture.",
          climateTitle: "Conditions Climatiques",
          climateDesc: "Donn√©es m√©t√©orologiques mises √† jour toutes les heures √† partir de stations mondiales : temp√©rature de l'air, humidit√© relative, vitesse du vent et conditions atmosph√©riques. Nous √©valuons si votre microclimat actuel favorise la croissance de votre culture sp√©cifique selon des param√®tres agronomiques.",
          soilTitle: "Stabilit√© du Sol",
          soilDesc: "La technologie radar √† synth√®se d'ouverture (SAR) de Sentinel-1 d√©tecte les mouvements millim√©triques du sol. Nous mesurons la subsidence, l'expansion du sol et les microd√©formations pouvant affecter les syst√®mes d'irrigation, les structures agricoles et le d√©veloppement racinaire.",
          howWorks: "Technologie satellitaire au service de votre ferme",
          step1: "Saisissez les coordonn√©es de votre ferme",
          step2: "Nos algorithmes interrogent les satellites Sentinel en temps r√©el",
          step3: "Vous recevez une analyse d√©taill√©e avec des recommandations sp√©cifiques",
          step4: "Visualisez l'emplacement analys√© sur une carte interactive",
          coverage: "Couverture : Mondiale",
          resolution: "R√©solution : jusqu'√† 10 m√®tres",
          crops: "15 cultures prises en charge",
          speed: "Analyse en moins de 30 secondes",
          cropsTitle: "Cultures analys√©es",
          analyzeFarm: "Analyser la Ferme",
          farmName: "Nom de la ferme",
          latitude: "Latitude",
          longitude: "Longitude",
          cropType: "Type de culture",
          selectCrop: "S√©lectionner..."
      },
      it: {
          heroTitle: "AgroStable - Analisi Satellitare Agricola Intelligente",
          heroSubtitle: "Previeni le perdite del raccolto con dati satellitari in tempo reale",
          heroDescription: "Analizza la salute della tua piantagione, le condizioni climatiche e la stabilit√† del suolo utilizzando la pi√π recente tecnologia spaziale",
          heroButton: "Analizza la mia fattoria gratis",
          whatAnalyze: "Cosa analizziamo nella tua azienda?",
          ndviTitle: "NDVI - Salute delle Piante",
          ndviDesc: "Utilizzando immagini multispettrali Sentinel-2, misuriamo la riflettanza infrarossa delle tue colture. Valori elevati indicano vegetazione densa e sana, mentre valori bassi rivelano stress idrico, carenze nutrizionali, parassiti o malattie. Il nostro algoritmo confronta il tuo NDVI con intervalli ottimali specifici per ogni coltura.",
          climateTitle: "Condizioni Climatiche",
          climateDesc: "Dati meteorologici aggiornati ogni ora da stazioni globali: temperatura dell'aria, umidit√† relativa, velocit√† del vento e condizioni atmosferiche. Valutiamo se il tuo microclima attuale favorisce la crescita della tua coltura specifica secondo parametri agronomici.",
          soilTitle: "Stabilit√† del Suolo",
          soilDesc: "La tecnologia radar ad apertura sintetica (SAR) di Sentinel-1 rileva movimenti millimetrici del terreno. Misuriamo subsidenza, espansione del suolo e microdeformazioni che possono influenzare i sistemi di irrigazione, le strutture agricole e lo sviluppo radicale.",
          howWorks: "Tecnologia satellitare al servizio della tua azienda",
          step1: "Inserisci le coordinate della tua azienda",
          step2: "I nostri algoritmi consultano i satelliti Sentinel in tempo reale",
          step3: "Ricevi un'analisi dettagliata con raccomandazioni specifiche",
          step4: "Visualizza la posizione analizzata su una mappa interattiva",
          coverage: "Copertura: Mondiale",
          resolution: "Risoluzione: fino a 10 metri",
          crops: "15 colture supportate",
          speed: "Analisi in meno di 30 secondi",
          cropsTitle: "Colture analizzate",
          analyzeFarm: "Analizza Fattoria",
          farmName: "Nome della fattoria",
          latitude: "Latitudine",
          longitude: "Longitudine",
          cropType: "Tipo di coltura",
          selectCrop: "Seleziona..."
      }
  };

  function changeLanguage() {
      const lang = document.getElementById('languageSelect').value;
      const texts = translations[lang];
      Object.keys(texts).forEach(key => {
          const element = document.querySelector(`[data-translate="${key}"]`);
          if (element) {
              if (element.tagName === 'INPUT' || element.tagName === 'OPTION') {
                  element.placeholder = texts[key];
                  if (element.tagName === 'OPTION') element.textContent = texts[key];
              } else {
                  element.textContent = texts[key];
              }
          }
      });
  }
  </script>
</body>
</html> 