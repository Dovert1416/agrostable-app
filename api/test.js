const { createClient } = require('@supabase/supabase-js')
const ee = require('@google/earthengine')

// CONFIGURACI√ìN SUPABASE
const supabaseUrl = 'https://ahcwnifxpmrzqpykagxa.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoY3duaWZ4cG1yenFweWthZ3hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTcwMDEsImV4cCI6MjA2ODI3MzAwMX0.m6MGKUb6FU5LKHhWDLrI8h9wKn9nOtxMo5EVnkr7ycs'
const supabase = createClient(supabaseUrl, supabaseKey)

// CONFIGURACI√ìN GOOGLE EARTH ENGINE (usa las variables de entorno que ya tienes)
let eeInitialized = false
async function initializeEE() {
  if (!eeInitialized) {
    try {
      const privateKey = process.env.GEE_PRIVATE_KEY.replace(/\\n/g, '\n')
      const serviceAccount = {
        type: "service_account",
        project_id: process.env.GEE_PROJECT_ID,
        private_key_id: process.env.GEE_PRIVATE_KEY_ID,
        private_key: privateKey,
        client_email: process.env.GEE_CLIENT_EMAIL,
        client_id: process.env.GEE_CLIENT_ID,
        auth_uri: "https://accounts.google.com/o/oauth2/auth",
        token_uri: "https://oauth2.googleapis.com/token",
        auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
        client_x509_cert_url: process.env.GEE_CLIENT_CERT_URL
      }
      
      await ee.initialize({ credentials: serviceAccount })
      eeInitialized = true
      console.log('‚úÖ Google Earth Engine inicializado')
    } catch (error) {
      console.error('‚ùå Error Google Earth Engine:', error)
      throw error
    }
  }
}

// FUNCI√ìN PARA OBTENER NDVI REAL DE SENTINEL-2 (PROMEDIO √öLTIMOS 30 D√çAS)
async function getRealNDVI(latitude, longitude) {
  try {
    await initializeEE()
    
    const point = ee.Geometry.Point([longitude, latitude])
    const endDate = new Date()
    const startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000) // 30 d√≠as atr√°s
    
    // OBTENER IM√ÅGENES SENTINEL-2 DE √öLTIMOS 30 D√çAS CON MENOS DE 20% NUBES
    const collection = ee.ImageCollection('COPERNICUS/S2_SR')
      .filterBounds(point)
      .filterDate(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0])
      .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    
    // CALCULAR NDVI PROMEDIO
    const ndviCollection = collection.map(function(image) {
      const ndvi = image.normalizedDifference(['B8', 'B4']).rename('NDVI')
      return ndvi
    })
    
    const ndviMean = ndviCollection.mean()
    
    // OBTENER VALOR EN EL PUNTO ESPEC√çFICO
    const ndviValue = await new Promise((resolve, reject) => {
      ndviMean.sample({
        region: point,
        scale: 10,
        numPixels: 1
      }).evaluate((result, error) => {
        if (error) {
          console.error('Error NDVI:', error)
          resolve(0.5) // Valor por defecto si hay error
        } else {
          const features = result.features
          if (features && features.length > 0) {
            const ndvi = features[0].properties.NDVI
            resolve(ndvi ? Math.max(0.1, Math.min(1.0, ndvi)) : 0.5)
          } else {
            resolve(0.5)
          }
        }
      })
    })
    
    return ndviValue
    
  } catch (error) {
    console.error('Error consultando NDVI real:', error)
    return 0.5 // Valor por defecto si falla
  }
}

// FUNCI√ìN PARA OBTENER SUBSIDENCIA REAL DE SENTINEL-1 (PROMEDIO √öLTIMOS 30 D√çAS)
async function getRealSubsidence(latitude, longitude) {
  try {
    await initializeEE()
    
    const point = ee.Geometry.Point([longitude, latitude])
    const endDate = new Date()
    const startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000)
    
    // OBTENER IM√ÅGENES SENTINEL-1 DE √öLTIMOS 30 D√çAS
    const collection = ee.ImageCollection('COPERNICUS/S1_GRD')
      .filterBounds(point)
      .filterDate(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0])
      .filter(ee.Filter.eq('instrumentMode', 'IW'))
      .select('VH')
    
    const backscatterMean = collection.mean()
    
    // OBTENER VALOR Y CONVERTIR A SUBSIDENCIA ESTIMADA
    const subsidenceValue = await new Promise((resolve, reject) => {
      backscatterMean.sample({
        region: point,
        scale: 10,
        numPixels: 1
      }).evaluate((result, error) => {
        if (error) {
          console.error('Error Subsidencia:', error)
          resolve(1.5)
        } else {
          const features = result.features
          if (features && features.length > 0) {
            const vh = features[0].properties.VH || -15
            // Convertir backscatter a subsidencia estimada (f√≥rmula emp√≠rica)
            const subsidenceRate = (vh + 15) * 0.4
            resolve(Math.round(subsidenceRate * 10) / 10)
          } else {
            resolve(1.5)
          }
        }
      })
    })
    
    return subsidenceValue
    
  } catch (error) {
    console.error('Error consultando subsidencia real:', error)
    return 1.5
  }
}

export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS')
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type')
  
  if (req.method === 'OPTIONS') {
    res.status(200).end()
    return
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }
  
  try {
    const { latitude, longitude, cropType } = req.body
    
    if (!latitude || !longitude || !cropType) {
      return res.status(400).json({ error: 'Faltan par√°metros requeridos' })
    }

    console.log(`üîç Analizando: ${cropType} en ${latitude}, ${longitude}`)

    // 1. OBTENER CLIMA REAL (OpenWeatherMap)
    let climateData = null
    try {
      const weatherResponse = await fetch(
        `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=f119193413f32381c7cb204e959d7fc1&units=metric&lang=es`
      )
      if (weatherResponse.ok) {
        const weatherData = await weatherResponse.json()
        climateData = {
          temperature: Math.round(weatherData.main?.temp || 20),
          humidity: Math.round(weatherData.main?.humidity || 65),
          description: weatherData.weather?.[0]?.description || 'N/A'
        }
        console.log('‚úÖ Clima real obtenido:', climateData.temperature + '¬∞C')
      }
    } catch (error) {
      console.error('‚ùå Error clima:', error)
      climateData = { temperature: 22, humidity: 65, description: 'Error en consulta' }
    }

    // 2. OBTENER NDVI REAL (Google Earth Engine - Sentinel-2)
    console.log('üõ∞Ô∏è Consultando NDVI real...')
    const ndviValue = await getRealNDVI(latitude, longitude)
    console.log('‚úÖ NDVI real obtenido:', ndviValue)

    // 3. OBTENER SUBSIDENCIA REAL (Google Earth Engine - Sentinel-1)
    console.log('üèîÔ∏è Consultando subsidencia real...')
    const subsidenceValue = await getRealSubsidence(latitude, longitude)
    console.log('‚úÖ Subsidencia real obtenida:', subsidenceValue + ' mm/a√±o')

    // 4. AN√ÅLISIS INTELIGENTE CON DATOS REALES
    const analysis = analyzeCropConditions(ndviValue, subsidenceValue, climateData, cropType)

    // 5. RESPUESTA CON DATOS REALES
    res.status(200).json({
      ndvi: ndviValue,
      climate: climateData,
      subsidence: subsidenceValue,
      recommendations: analysis.recommendations,
      score: analysis.score,
      analysis: analysis.details,
      source: 'Datos reales de sat√©lites Sentinel-2 y Sentinel-1 (promedio 30 d√≠as)'
    })
    
  } catch (error) {
    console.error('‚ùå Error general:', error)
    res.status(500).json({ error: 'Error interno del servidor' })
  }
}

function analyzeCropConditions(ndvi, subsidence, climate, cropType) {
  let score = 100
  let recommendations = []
  let details = {}

  // AN√ÅLISIS NDVI REAL
  let ndviStatus = ''
  let ndviPenalty = 0
  
  if (ndvi >= 0.8) {
    ndviStatus = 'EXCELENTE'
    ndviPenalty = 0
  } else if (ndvi >= 0.6) {
    ndviStatus = 'BUENO'
    ndviPenalty = 5
  } else if (ndvi >= 0.4) {
    ndviStatus = 'REGULAR'
    ndviPenalty = 15
  } else if (ndvi >= 0.2) {
    ndviStatus = 'MALO'
    ndviPenalty = 25
  } else {
    ndviStatus = 'CR√çTICO'
    ndviPenalty = 35
  }
  
  score -= ndviPenalty
  details.ndvi = { value: ndvi, status: ndviStatus, penalty: ndviPenalty }
  
  if (ndviStatus === 'CR√çTICO') {
    recommendations.push(`üö® URGENTE: NDVI cr√≠tico (${Math.round(ndvi * 100)}%) en ${cropType}. Implementar riego de emergencia inmediatamente.`)
  } else if (ndviStatus === 'REGULAR') {
    recommendations.push(`üå± NDVI regular (${Math.round(ndvi * 100)}%) para ${cropType}. Aumentar frecuencia de riego y fertilizaci√≥n.`)
  } else {
    recommendations.push(`‚úÖ NDVI ${ndviStatus.toLowerCase()} (${Math.round(ndvi * 100)}%) para ${cropType}. Mantener pr√°cticas actuales.`)
  }

  // AN√ÅLISIS SUBSIDENCIA REAL
  const absSubsidence = Math.abs(subsidence)
  let subsidenceStatus = ''
  let subsidencePenalty = 0
  
  if (absSubsidence <= 1) {
    subsidenceStatus = 'ESTABLE'
    subsidencePenalty = 0
  } else if (absSubsidence <= 3) {
    subsidenceStatus = 'LIGERAMENTE INESTABLE'
    subsidencePenalty = 10
  } else if (absSubsidence <= 6) {
    subsidenceStatus = 'INESTABLE'
    subsidencePenalty = 25
  } else {
    subsidenceStatus = 'CR√çTICO'
    subsidencePenalty = 40
  }
  
  score -= subsidencePenalty
  details.subsidence = { value: subsidence, status: subsidenceStatus, penalty: subsidencePenalty }
  
  if (subsidenceStatus === 'CR√çTICO') {
    recommendations.push(`‚ö†Ô∏è SUBSIDENCIA CR√çTICA: ${subsidence} mm/a√±o. Revisar sistemas de riego por posibles rupturas.`)
  } else if (subsidenceStatus === 'ESTABLE') {
    recommendations.push(`‚úÖ TERRENO ESTABLE: ${subsidence} mm/a√±o. Excelente para ${cropType}.`)
  } else {
    recommendations.push(`üìä SUBSIDENCIA ${subsidenceStatus}: ${subsidence} mm/a√±o. Monitoreo preventivo recomendado.`)
  }

  // AN√ÅLISIS CLIMA REAL
  let tempPenalty = 0
  if (climate && climate.temperature !== null) {
    if (climate.temperature < 15) {
      tempPenalty = 20
      recommendations.push(`‚ùÑÔ∏è TEMPERATURA BAJA: ${climate.temperature}¬∞C puede afectar ${cropType}. Considerar protecci√≥n t√©rmica.`)
    } else if (climate.temperature > 35) {
      tempPenalty = 20
      recommendations.push(`üî• TEMPERATURA ALTA: ${climate.temperature}¬∞C puede estresar ${cropType}. Aumentar riego.`)
    } else {
      recommendations.push(`üå°Ô∏è TEMPERATURA ADECUADA: ${climate.temperature}¬∞C es buena para ${cropType}.`)
    }
    
    score -= tempPenalty
    details.temperature = { value: climate.temperature, penalty: tempPenalty }
  }

  // L√çMITE M√çNIMO DE PUNTUACI√ìN
  score = Math.max(15, Math.min(100, score))
  
  return {
    score: score,
    recommendations: recommendations.slice(0, 5),
    details: details
  }
}
